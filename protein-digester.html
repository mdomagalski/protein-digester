<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-button/paper-button.html">
<script src="../fishtones-js/dist/fishtones-js-bundle-min.js"></script>
<script src="../xregexp/xregexp-all.js"></script>
<script src="xregexp-lookbehind2.js"></script>
<script src="polypeptide-digester.js"></script>
<script src="enzymes.js"></script>


<dom-module id="protein-digester">
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style is="protein-digester-style">
        :root {
            --paper-input-error:{
                line-height: 32px;
                font-size: 18px;
            };
        }

        paper-item {
            display: block;
            position: relative;
            min-height: 32px;
            padding: 0px 16px;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -ms-flex-direction: row;
            -webkit-flex-direction: row;
            flex-direction: row;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;
            font-family: 'Roboto', 'Noto', sans-serif;
            -webkit-font-smoothing: antialiased;
            font-size: 16px;
            font-weight: 400;
            line-height: 24px;
        }

        paper-button.indigo {
            font-family: "Roboto";
            background-color: var(--paper-indigo-500);
            color: white;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-indigo-a300) !important;
                color: white !important;
            };
            margin-top: 15px;
        }

        paper-input {
            width: 225px;
            margin: 0 20px;
        }
    </style>
    <template>
        <iron-ajax
            id="ajax"
            method="GET"
            url="http://www.uniprot.org/uniprot/{{uniprotId}}&format=fasta"
            handle-as="text"
            on-response="handleResponse"
            debounce-duration="300">
        </iron-ajax>
        <div class="layout horizontal wrap">
        <paper-input id="uniprotId" name="uniprotId"
                     label="UniProt ID" value="{{uniprotId}}"
                     pattern="[OPQ][0-9][A-Z0-9]{3}[0-9]|[A-NR-Z][0-9]([A-Z][A-Z0-9]{2}[0-9]){1,2}"
                     required auto-validate
                     error-message="It is not a valid UniProt identifier!">
        </paper-input>
        <paper-dropdown-menu id="enzyme" name="enzyme"
                     label="Enzyme" value="{{enzyme}}"
                     error-message="Please select an enzyme!">
            <paper-listbox class="dropdown-content">
                <template id="enzymesMenu" is="dom-repeat" items="{{enzymeList}}" attr-for-selected="value">
                    <paper-item id="enzyme{{index}}" value="{{item}}">{{item}}</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>
        <paper-input id="missedCleavages" name="missedCleavages"
                     label="Number of missed cleavages" value="{{missedCleavages}}"
                     pattern="\d+"
                     required auto-validate
                     error-message="Only numeric values!">
        </paper-input>
        <paper-input id="minPeptideLength" name="minPeptideLength"
                     label="Minimal peptide length (optional)" value="{{minPeptideLength}}"
                     pattern="\d+"
                     auto-validate
                     error-message="Only numeric values!">
        </paper-input>
        <paper-input id="maxPeptideLength" name="maxPeptideLength"
                     label="Maximal peptide length (optional)" value="{{maxPeptideLength}}"
                     pattern="\d+"
                     auto-validate
                     error-message="Only numeric values!">
        </paper-input>
        <div class="buttonPadding"><paper-button raised class="indigo" on-click="digest">digest</paper-button></div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'protein-digester',
            properties: {
                uniprotRegexp: {
                    value: /[OPQ][0-9][A-Z0-9]{3}[0-9]|[A-NR-Z][0-9]([A-Z][A-Z0-9]{2}[0-9]){1,2}/g
                },
                enzymeList: {
                    type: Array
                },
                enzyme: {
                    type: String,
                    value: "trypsin"
                },
                missedCleavages: {
                    type: Number,
                    value: 1
                },
                minPeptideLength: {
                    type: Number,
                    value: null
                },
                maxPeptideLength: {
                    type: Number,
                    value: null
                },
                uniprotId: {
                    type: String,
                    observer: 'fetchProtein'
                },
                proteinSequence: {
                    type: String,
                    //observer: 'digest'
                },
                enzyme: {
                    type: String,
                    value: "trypsin"
                }
            },
            attached: function(){
                this.enzymeList = Object.keys(enzymes);
            },
            fetchProtein: function(){
                if(this.uniprotRegexp.test(this.uniprotId)){
                    this.$.ajax.generateRequest();
                }
            },
            handleResponse: function(request) {
                response = request.detail.response;
                var fastaArray = response.split('\n');
                //var fastaHeader = fastaArray[0];
                this.proteinSequence = fastaArray.slice(1,fastaArray._length).toString().replace(/,/g,"");
            },
            digest: function() {
                var digester = new cleave(
                    this.proteinSequence,
                    this.enzyme,
                    this.missedCleavages,
                    this.minPeptideLength,
                    this.maxPeptideLength
                );
                console.log(digester);
            }
        });
    </script>
</dom-module>
